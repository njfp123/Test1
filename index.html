<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Wish List</title>
    <!-- Using Tailwind CSS for styling from a CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto max-w-2xl p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Community Wish List âœ¨</h1>
            <p class="text-gray-600 mt-2">What's one thing you wish for? Share it with the world!</p>
        </header>

        <!-- Form for adding a new wish -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <form id="wish-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                    <input type="text" id="username" name="username" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Alex" required>
                </div>
                <div class="mb-4">
                    <label for="wish" class="block text-sm font-medium text-gray-700 mb-1">Your Wish</label>
                    <textarea id="wish" name="wish" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="I wish for a sunny weekend..." required></textarea>
                </div>
                <button type="submit" id="submit-button" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                    Add to List
                </button>
            </form>
            <div id="form-message" class="mt-4 text-center"></div>
        </div>

        <!-- Section to display wishes -->
        <main>
            <h2 class="text-2xl font-bold text-center mb-6">Everyone's Wishes</h2>
            <div id="loading" class="flex justify-center items-center h-24">
                <div class="loader"></div>
            </div>
            <div id="wishes-list" class="space-y-4">
                <!-- Wishes will be dynamically inserted here -->
            </div>
        </main>

    </div>

    <script>
        // --- DOM Elements ---
        const wishForm = document.getElementById('wish-form');
        const submitButton = document.getElementById('submit-button');
        const formMessage = document.getElementById('form-message');
        const wishesList = document.getElementById('wishes-list');
        const loadingIndicator = document.getElementById('loading');

        // --- API Endpoints for Netlify Functions ---
        const API_ADD_WISH = '/.netlify/functions/add-wish';
        const API_GET_WISHES = '/.netlify/functions/get-wishes';

        /**
         * Fetches all wishes from the backend and displays them.
         */
        async function fetchAndDisplayWishes() {
            loadingIndicator.style.display = 'flex';
            wishesList.innerHTML = ''; // Clear existing list

            try {
                const response = await fetch(API_GET_WISHES);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const wishes = await response.json();
                
                if (wishes.length === 0) {
                    wishesList.innerHTML = `<p class="text-center text-gray-500">No wishes yet. Be the first!</p>`;
                } else {
                    wishes.forEach(wish => {
                        const wishElement = document.createElement('div');
                        wishElement.className = 'bg-white p-5 rounded-xl shadow-sm border border-gray-200';
                        wishElement.innerHTML = `
                            <p class="text-lg text-gray-800">"${wish.wish_text}"</p>
                            <p class="text-right text-sm text-gray-500 mt-2">- <strong>${wish.username}</strong> on ${new Date(wish.created_at).toLocaleDateString()}</p>
                        `;
                        wishesList.appendChild(wishElement);
                    });
                }

            } catch (error) {
                wishesList.innerHTML = `<p class="text-center text-red-500">Could not load wishes. Please try again later.</p>`;
                console.error('Error fetching wishes:', error);
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        /**
         * Handles the form submission to add a new wish.
         */
        wishForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            // Disable button and show loading state
            submitButton.disabled = true;
            submitButton.textContent = 'Adding...';
            formMessage.textContent = '';

            const formData = new FormData(wishForm);
            const username = formData.get('username');
            const wish = formData.get('wish');

            try {
                const response = await fetch(API_ADD_WISH, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, wish }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Something went wrong.');
                }

                // Success
                formMessage.textContent = 'Your wish has been added!';
                formMessage.className = 'mt-4 text-center text-green-600';
                wishForm.reset();
                
                // Refresh the list to show the new wish
                await fetchAndDisplayWishes();

            } catch (error) {
                formMessage.textContent = `Error: ${error.message}`;
                formMessage.className = 'mt-4 text-center text-red-600';
                console.error('Error adding wish:', error);
            } finally {
                // Re-enable button
                submitButton.disabled = false;
                submitButton.textContent = 'Add to List';
            }
        });

        // --- Initial Load ---
        // Fetch and display wishes when the page first loads.
        document.addEventListener('DOMContentLoaded', fetchAndDisplayWishes);
    </script>

</body>
</html>
